
<!-- TOC -->

- [WebRTC 处理过程](#webrtc-处理过程)
	- [WebRTC 进行音视频通话的大体过程。](#webrtc-进行音视频通话的大体过程)
	- [音视频采集](#音视频采集)
	- [选用什么协议](#选用什么协议)

<!-- /TOC -->

-------


## WebRTC 处理过程


![](https://static001.geekbang.org/resource/image/c5/a0/c536a1dd0ed50008d2ada594e052d6a0.png)

假如说有两个 WebRTC 终端（上图中的两个大方框）、一个 Signal（信令）服务器和一个 STUN/TURN 服务器。

- WebRTC 终端：负责音视频采集，编解码，NAT 穿越、音视频数据传输
- Signal 服务器，负责信令处理，如加入房间、离开房间、媒体协商消息的传递等。
- STUN/TURN 服务器，负责获取 WebRTC 终端在公网的 IP 地址，以及 NAT 穿越失败后的数据中转。

### WebRTC 进行音视频通话的大体过程。

当一端（WebRTC 终端）进入房间之前，它首先会检测自己的设备是否可用。如果此时设备可用，则进行音视频数据采集

采集到的数据一方面可以做预览，也就是让自己可以看到自己的视频；另一方面，可以将其录制下来保存成文件，等到视频通话结束后，上传到服务器让用户回看之前的内容。

在获取音视频数据就绪后，WebRTC 终端要发送 “加入” 信令到 Signal 服务器。Signal 服务器收到该消息后会创建房间。在另外一端，也要做同样的事情，只不过它不是创建房间，而是加入房间了。待第二个终端成功加入房间后，第一个用户会收到 “另一个用户已经加入成功” 的消息。

此时，第一个终端将创建 “媒体连接” 对象，即 RTCPeerConnection ,并将采集到的音视频数据通过 RTCPeerConnection 对象进行编码，最终通过 P2P 传送给对端。

当然，在进行 P2P 穿越时很有可能失败。所以，当 P2P 穿越失败时，为了保障音视频数据仍然可以互通，则需要通过 TURN 服务器（TURN 服务会在后面文章中专门介绍）进行音视频数据中转。

这样，当音视频数据来到对端后，对端首先将收到的音视频数据进行解码，最后再将其展示出来，这样就完成了一端到另一端的单通。如果双方要互通，那么，两方都要通过 RTCPeerConnection 对象传输自己一端的数据，并从另一端接收数据。

### 音视频采集

在浏览器打开摄像头

首先执行 `getUserMedia()` 方法，这个方法会去访问 摄像头，经过用户允许后，调用 `gotLocalMediaStream` 方法。

在 gotLocalMediaStream 方法中，其输入参数为 MediaStream 对象，该对象中存放着 getUserMedia 方法采集到的**音视频轨**。

我们将它作为视频源赋值给 HTML5 的 video 标签的 srcObject 属性。这样在 HTML 页面加载之后，就可以在该页面中看到摄像头采集到的视频数据了。

### 选用什么协议

实现一套实时互动直播系统，在选择网络传输协议时，你会选择使用 UDP 协议还是 TCP 协议呢？

必须使用 UDP

为什么一定要使用 UDP 呢？关于这个问题，你可以反向思考下，假如使用 TCP 会怎样呢？在极端网络情况下，TCP 为了传输的可靠性，它是如何做的呢？简单总结起来就是“**发送 -> 确认；超时 -> 重发**”的反复过程。

TCP 的超时重传会带来较大的迟延

一般情况下，在实时互动直播系统传输音视频数据流时，我们并不直接将音视频数据流交给 UDP 传输，而是先给音视频数据加个 RTP 头，然后再交给 UDP 进行传输。

我们以视频帧为例，一个 I 帧的数据量是非常大的，最少也要几十 K ，而以太网的最大传输单元是多少呢？ 1.5K，所以要传输一个 I 帧需要几十个包。并且这几十个包传到对端后，还要重新组装成 I 帧，这样才能进行解码还原出一幅幅的图像。如果是我们自己实现的话，要完成这样的过程，至少需要以下几个标识。

- 序号：用于标识传输包的序号，这样就可以知道这个包是第几个分片了。
- 起始标记：记录分帧的第一个 UDP 包。
- 结束标记：记录分帧的最后一个 UDP 包。

有了上面这几个标识字段，我们就可以在发送端进行拆包，在接收端将视频帧重新再组装起来了。


----------



- 使用 Medooze 实现多方视频会议
- 使用 Canvas 绘制统计图表进行数据统计。
- 使用 SFU 架构实现多人音视频实时通话
- 采用 HLS 协议构建直播架构模型，从 CDN 拉取媒体流







