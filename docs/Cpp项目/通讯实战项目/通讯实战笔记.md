

<!-- TOC -->

- [Nginx的整体结构](#nginx的整体结构)
- [Nginx源码解读](#nginx源码解读)



-------

## Nginx的整体结构 

Nginx启动后，一个是 master 进程，一个是 worker 进程，master 进程是一个监控进程，不处理具体的业务，专门用来管理和监控 worker  进程。

![](https://cdn.jsdelivr.net/gh/kendall-cpp/blogPic@main/寻offer总结/nginx进程.4bsq0g8wmk80.png)

## Nginx源码解读

首先编写自己的 `nginx.c`

```c
#include <stdio.h>
#include <unistd.h>

int main() {

	printf("this is 通讯架构实战C++\n");
	for(;;){
		printf("休息一秒\n");
		sleep(1);
	}

	printf("程序退出了，再见\n");
	return 0;
}
```

在一个终端运行自己写的`nginx.c`,然后在另一个终端执行下面命令

```bash
kendall@ubuntu:~$ ps -eo pid,ppid,sid,tty,pgrp,comm | grep -E 'bash|PID|nginx'
   PID   PPID    SID TT         PGRP COMMAND
  1221   1218   1221 pts/0      1221 bash
  1515      1   1515 ?          1515 nginx
  1550   1515   1515 ?          1515 nginx
  1552   1515   1515 ?          1515 nginx
  1553   1515   1515 ?          1515 nginx
  1575   1515   1515 ?          1515 nginx
  1618   1617   1618 ?          1618 bash
  1620   1618   1618 ?          1618 bash
  1845   1764   1845 pts/3      1845 bash
  2225   2223   2225 pts/4      2225 bash
  2246   1845   1845 pts/3      2246 nginx
```

使用 strace 调试分析工具，可用于跟踪程序执行时进程的系统调用（`system call`)
```bash
 sudo strace -e trace=signal -p 2246
 ```

 如果运行nginx 的终端退出了，就会输出：

 ```
--- SIGHUP {si_signo=SIGHUP, si_code=SI_USER, si_pid=1845, si_uid=1000} ---
+++ killed by SIGHUP +++
 ```


```c
#include <stdio.h>
#include <unistd.h>
 #include <signal.h>

int main() {

	printf("this is 通讯架构实战C++\n");

	//忽略信号
	signal(SIGHUP,SIG_IGN);
	//SIG_IGN 代表我要求忽略该信号，请求操作系统不要执行默认的该信号处理动作（就是不要把进程杀死）
	
	setsid();  //该函数用于建立一个新会话  //但是组长调用setsid()是无效的

	for(;;){
		printf("休息一秒\n");
		sleep(1);
	}

	printf("程序退出了，再见\n");
	return 0;
}
```

```c
#include <stdio.h>
#include <unistd.h>
 #include <signal.h>

int main() {


	pid_t pid;

	printf("this is 通讯架构实战C++\n");


	pid = fork();
	if(pid < 0) {
		printf("fork进程出错\n");
	}
	else if(pid == 0) {
		printf("这是子进程在运行\n");

		//在子进程里面创建新的 zsession 会话
		setsid();
		for(;;) {
			sleep(1);
			printf("子进程休息 1 秒\n");
		}
		return 0;
	}
	else {
		printf("这是父进程子啊运行\n");
		for(;;){
			sleep(1);
			printf("父进程休息 1 秒\n");
		}
		printf("父进程结束，再见！\n");
	}

	//忽略信号
	// signal(SIGHUP,SIG_IGN);
	//SIG_IGN 代表我要求忽略该信号，请求操作系统不要执行默认的该信号处理动作（就是不要把进程杀死）

	
;
	return 0;
}
```




