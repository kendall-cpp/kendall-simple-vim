# USB 笔记

## 什么是端点

所有的总线传输要么是传到设备端点 (device endpoint)，要么是从设备端点传送过来。端点其实就是**多个数据直接的缓冲区** ， 所以端点中存的数据是**待发送的**数据或者是**待接收的**数据，

另外主机没有端点，但是同样有缓冲区，

端点的地址由【端点号 (0-15)】和【方向 (in / out)】组成，

device --in--> 主机 --out--> device 

每个设备都必须要有 1 个控制端点【端点 0】 。控制端点包含着一对 IN 和 OUT 端点地址。

除了端点 0 外， 全速 和 高速 设备可拥有多达 30 个额外端点地址（1-15的 IN 和 OUT），低速设备最多有两个端点地址，可以是两个 IN 、两个 OUT 或者两个方向各一个。

## USB 传输类型

我们知道，传输事务解决了主机、设备之间交互一次数据的问题，但是有些端点是需要进行多次双向传输或者多次单向传输的，同时因为设备的功能不同，所需要的带宽和传输特性也不同，那么就需要一个更上层的机制解决以上问题，也就是 USB 的四大传输。

控制传输（Control Transfers）、中断传输（Interrupt Transfers）、批量传输（Bulk Transfers）、同步传输（Isochronous Transfers）称之为四大传输。

### 控制传输

**一种可靠的双向传输**。 控制传输分为 初始设置阶段--->数据阶段(不必须)--->状态信息 阶段，每个阶段都是由一个或者多个事物组成，每个控制传输必须包含有**设置和状态**阶段，不是所有的传输都有数据阶段。

该传输一般发生在端点 0 中，用于USB的枚举、配置（也可能进行其他数据传输）等阶段。

当设备插入主机后，主机通过端点 0 进行控制传输，通过一系列的数据交互，主机就可以知道连接的设备有多少个接口，有多少个可用的端点等设备信息。


#### 设置阶段

主机发送请求信息，开始设置事务。令牌信息包的 SETUP 包标识符 将事务 确定为可以开始控制传输的【设置事务】。

### 批量传输

### 中断传输

### 等时传输

---

# USB协议文档

## Universal Serial Bus Specification

USB 协议规范

（通用串行总线规范）是由USB Implementers Forum（USB-IF）制定和发布的一系列关于USB协议标准的文件。该规范详细介绍了USB协议的各个方面，包括物理层、数据链路层、传输层、设备和主机通信等各个方面。

该规范的版本包括USB 1.x、USB 2.0、USB 3.x和USB Type-C等，每个版本都有对应的规范文件。其中，USB 1.x规范包括USB 1.0、USB 1.1和USB 2.0低速（1.5 Mbps）和全速（12 Mbps）规范，USB 2.0规范则增加了高速（480 Mbps）规范，USB 3.x则增加了超高速（5 Gbps、10 Gbps）规范，而USB Type-C规范则对连接器和电源传输进行了扩充。

USB规范涵盖了USB协议栈的每个层次的内容，使厂商能够实现兼容的USB设备、主机和相关系统。同时该规范是为确保全球各地的USB设备能够相互兼容的必要手段，USB-IF官方认证标志和兼容性测试也建立于此规范基础上。


## USB Complete: The Developer's Guide

是由Jan Axelson所著的一本关于USB开发的指南书籍，它详细介绍了USB技术的原理、协议及其实现。该书可以帮助读者了解USB技术的基本概念和原理，并且提供了大量的实际案例和示例代码，使得读者能够更好地理解USB开发的技术细节。

该书共有26章，内容包括了从USB 1.x到USB 3.x、USB Type-C的各个版本协议的细节和特点，涉及到USB传输、设备和主机通信、USB的电源管理、HID设备和UVC摄像头等。除此之外，该书还介绍了USB的硬件设计、PCB设计、阻抗匹配、背板的设计等，并提供了一些开发工具和测试工具的推荐。

该书的读者面向USB开发工程师、硬件工程师、软件工程师以及对USB技术感兴趣的专业人士。读者可以根据自己的工作需要选择相关章节进行阅读，也可以作为USB开发的入门手册。


USB-IF官网地址为 https://www.usb.org ，您可以在该网站上注册成为会员并下载最新的USB规范和技术文档。

以下是一些常用的USB规范文档和技术文档的下载地址：

USB 2.0规范文档：https://www.usb.org/document-library/usb-20-specification
USB 3.2规范文档：https://www.usb.org/document-library/usb-32-specification-released-july-26-2019
USB Type-C规范文档：https://www.usb.org/document-library/usb-type-ctm-specification-revision-21
HID规范文档：https://www.usb.org/document-library/hid-111-spec-and-descriptors
UVC规范文档：https://www.usb.org/document-library/usb-video-class-specification-revision-20
以上地址仅供参考，如有变动或更新，请以USB-I



# crg 控制器和 dwc 控制器

CRG控制器和DWC控制器是常见的USB控制器，它们在USB设备中扮演着非常重要的角色。

CRG控制器（Clock and Reset Generator）是芯片中负责时钟和复位信号的发生和控制的模块，它可以控制内部时钟的频率、相位和稳定性，保证USB数据传输的精度和可靠性。 CRG控制器通常被用于控制USB PHY、USB OTG、UART、I2C等接口的时钟和复位功能。CRG控制器能够提供时钟生成器、PLL锁相环、时钟分频器、复位发生器等功能，可以满足系统中不同模块的时钟和复位信号需求。

DWC控制器（DesignWare® USB IP）是一组开源硬件IP，能够实现USB 2.0和USB 3.0的Host和Device功能；DWC控制器广泛应用于各种芯片，并得到了良好的市场口碑。DWC控制器能够提供高性能、低延迟的数据传输，并针对性能、功耗和面积等方面的要求，在内部集成了高度可定制和可配置的功能单元。DWC控制器能够支持不同的USB Phy和常见的USB应用层协议，例如Mass Storage、Audio、Human Interface Device（HID）等，适用于多种应用场景。

总的来说，CRG控制器是用于控制USB设备内部时钟和复位信号的模块，而DWC控制器是用于实现USB通信协议和数据传输的标准IP。这两种控制器在USB设备的设计和开发中扮演着非常重要的角色。

### USB驱动程序、USB控制器、USB DEVICE等的功能和相互作用方式

- USB控制器


USB控制器位于主板芯片组中，主要负责控制USB总线上所有的USB设备。USB控制器包括两个主要模块：

（1）主机控制器

主机控制器位于主机设备或USB主机控制器中。主机控制器负责与USB总线上的所有设备通信，包括识别和配置新的设备，带宽分配和电源管理等任务。

主机控制器还负责处理USB数据包，并将数据包从USB总线中接收或发送到USB设备。因此，在任何一个USB主机控制器上都会有一个或多个主机控制器，它们负责控制USB总线上的数据传输和管理。

（2）设备控制器

USB设备是指连接到USB总线上的任何外部设备。 USB设备需要遵循USB协议和设备通信规范，这将确保USB设备与其他类型的设备能够兼容和互相操作。

USB设备之间的通信主要依靠USB设备描述符，每个USB设备描述符有一个唯一的地址和类型，用于识别或通信到该设备。

每个USB设备通常包括一个或多个功能接口，这些功能接口为主机控制器提供了各种服务，例如打印、扫描、存储等。

- USB设备


USB设备是指USB总线上连接的外部设备，例如鼠标、键盘、打印机和手机等。每个USB设备通常包括一个设备控制器和一个或多个功能接口，它们向主机控制器提供各种服务。

USB设备需要支持标准的USB协议和通信协议，以确保与主机控制器和其他设备之间的兼容性和互操作性。

- USB驱动程序


USB驱动程序是一种接口软件，允许USB设备与操作系统通信。USB驱动程序通常包括硬件抽象层和驱动程序代码。

USB驱动程序负责：

（1）在USB设备上安装和卸载设备驱动程序。
（2）实现USB设备的基本功能。
（3）管理USB设备的电源和带宽使用情况。
（4）发送和接收数据包。

## USB phy

PHY（Physical Layer，物理层）是 USB 系统中的一个组成部分，它实现了 USB 总线物理层的功能，负责收发 USB 数据包和控制信号。因此，PHY 中包含了 USB 信号的收发电路和控制电路等。

USB PHY的作用是将高层协议（例如USB设备和主机的通信）、传输数据和电缆之间的物理网络层之间进行转换。它实现了USB总线的电气和物理规范。PHY 主要负责三个方面的功能：

（1）时序控制：确保数据和控制信号在正确定时发送和接收，这包括时钟频率的控制和延迟的补偿等。

（2）传输编码：转换 USB 数据并将其编码为数据传输模式，使它符合 USB 的标准传输协议。

（3）信号驱动：把转换后的数字信号驱动到 USB 总线中以进行数据传输。

需要注意的是，USB PHY 通常与芯片本身整合在一起，但是 USB PHY 并不是 USB 芯片本身的一部分，因为它可以由其他芯片提供支持。在实践中，USB PHY 的实现经常随着制造工艺和应用环境的变化而出现不同的工程挑战，因此，它的性能和设计需要根据具体情况进行优化和调整。


今年的任务：

- 零声学院+博客网址，需要认真看完： http://www.wowotech.net/sort/memory_management

- PCM EQ DRC 音频处理： https://www.cnblogs.com/yuanqiangfei/p/9896855.html

- 音效只是了解： https://blog.csdn.net/u011764302/article/details/122236564

- 学习音频子系统： lsken00 书签

- 《USB开发大全》

- 看哈工大的计算机组成原理课程，学习计算机组成原理，芯片一些知识，记笔记
  - 《计算机组成与设计：硬件 / 软件接口》
  - 深入理解计算机系统

- 研究C语言
  - 《C 陷阱与缺陷》
  - 《C 编程专家》

- 《设备驱动程序》 这本书也是必看

