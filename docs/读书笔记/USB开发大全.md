## USB 子系统

USB 子系统包括 USB 连接，USB Host Controller（USB主控制器）和 USB 设备三个部分。USB 设备还包括 Hub 和功能设备(Func)。

![](https://gitee.com/linKge-web/PerPic/raw/master/bookImg/ARM64biancheng/USB子系统.png)

- USB 主控制器：控制所有的 USB 设备的通信，一般，USB 设备是和控制器打交道的，不是和 CPU 打交道的，它会告诉控制器，它要对设备做什么，然后控制器再负责去处理这件事，让设备执行这个指令，等事情办完了再去通知 CPU。

- HUB ：USB扩展坞

- Compound Device: 将 Hub 和连接在 Hub 上的设备封装在一起所组成的设备（多个USB设备都有独立的地址）。
- Composite Device 是包含彼此独立的多个接口的设备（不管接多少接口，都只有一个地址）。

USB 通信最基本的形式是通过 USB 设备中的 EndPoint（端点）的东西，而主机和端点之间的数据传输是通过 Pipe（管道）。

端点就是通信的发送点或者接收点，要发送数据，只需要把数据发送到正确的端点就可以了，管道就是为了让我们能够找到端点。

USB 端点有自己的方向，in 或者 out，端点有四种类型，分别对应四种数据传输方式

- 控制传输：用来传送控制信息的，每个 USB 设备都会有一个 端口0 的控制端点，内核中的 USB core 使用它在设备插入的时候进行设备的配置
- 中断传输：用来以一个固定的速率传送少量的数据，USB 键盘和 USB 鼠标使用这种方式传输，USb 的触摸屏也是使用这种方式传输坐标信息等。
- 批量传输：用来传输大量的数据，确保数据没有丢失，但不保证在特定时间内完成，U 盘就是使用这种方式。
- 等时传输，同样用来传输大量的数据，但不保证数据是否到达，对于传送迟延比较敏感，比如 图像/声音 传输。

对于 Linux 内核来说，所有的 Hub 和设备都被看作是一个个逻辑设备（Logical Device），一个 USB 逻辑设备就是一系列端点的集合，它与主机之间的通信发生在主机上的一个缓冲区和设备上的一个端点之间，通过管道来传输数据，也就是说，管道的一端是主机上的一个缓冲区，一端是设备上的端点。

USB 端点被捆绑为一个接口，一个接口代表一个基本功能，有的设备具有多个接口。在 kernel 中，一个接口要对应一个驱动程序。

> 一个设备包含多个接口，一个接口可以具有多个端点

USB 系统中的第一个 USB 设备是 root Hub，它是和主机控制器绑定在一起的，它是连接 PCI 总线和 USB 总线的桥梁，USB 总线上的每个设备都一 Root Hub 的编号作为第一个号码，【号码-端口】表示插入的设备。

---

## USB 源码目录


