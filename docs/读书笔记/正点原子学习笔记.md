
- [第16章](#第16章)
	- [sysfs 文件系统](#sysfs-文件系统)
	- [编写 LED 应用程序](#编写-led-应用程序)
	- [开发板上测试](#开发板上测试)
- [GPIO 应用编程](#gpio-应用编程)

-----

## 第16章

### sysfs 文件系统

设备文件是硬件设备向应用层提供的一个接口，应用层通过对设备文件的 I/O 操作来控制硬件设备，所以设备文件和硬件设备是相互对应的。

我们除了通过设备文件进行操控硬件设备外，还可以通过 sysfs 文件系统对硬件设备进行操控。

**sysfs 是一个基于内存的文件系统**，也就是虚拟文件系统，它的作用是将内核信息以文件的方式提供给应用层使用。sysfs 文件系统挂载在 `/sys` 目录下。

首先连接上开发板，进入到 `/sys` 目录下

```
root@ATK-IMX6U:/sys# ls
block  bus  class  dev  devices  firmware  fs  fsl_otp  kernel  module  power

root@ATK-IMX6U:/sys/class/leds# ls
beep  mmc0::  mmc1::  sys-led

root@ATK-IMX6U:/sys/class/leds/sys-led# ls
brightness  device  max_brightness  power  subsystem  trigger  uevent
```

 sys-led 是地板上的用户 LED 设备文件夹。这里需要关注 brightness、 max_brightness 以及 trigger 三个文件。

- brightness：设置 LED 的亮度等级或者获取当前 LED 的亮度等级， brightness 等于 0 表示 LED 灭，brightness 为正整数表示 LED 亮，其值越大、LED 越亮。对于开发板上的 LED 只有亮与不亮，没有亮度的调节。

- max_brightness：该属性文件只能被读取，不能写，用于获取 LED 设备的最大亮度等级。

- trigger：获取 LED 当前的触发模式（亮，灭，定时闪烁等）

### 编写 LED 应用程序

```
#include <stdio.h>
 #include <errno.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>


#define LED_TRIGGER "/sys/class/leds/sys-led/trigger"    // led 等触发模式配置文件
#define LED_BRIGHTNESS "/sys/class/leds/sys-led/brightness"   //led 的亮度
#define USAGE() fprintf(stderr, "usage:\n" \
					" %s <on|off>\n" \
					" %s <trigger> <type>\n", argv[0], argv[0])

int main(int argc, char **argv)
{
	int fd1,fd2;
	if(argc < 2)
	{
		USAGE();  //stdio.h
		exit(-1);
	}

	//打开文件
	fd1 = open(LED_TRIGGER,O_RDWR);
	if(fd1 == -1)
	{
		perror("open error");
		exit(-1);
	}
	fd2 = open(LED_BRIGHTNESS,O_RDWR);
	if(fd2 == -1) 
	{
		perror("open error");
		exit(-1);
	}
	//根据传参控制 led 灯
	if(!strcmp(argv[1],"on"))
	{
		write(fd1,"none",4);   // led 等触发模式配置文件
		write(fd2,"1",1);  //打开 led 灯
	}
	else if(!strcmp(argv[1],"off"))
	{
		write(fd1,"none",4); 
		write(fd2,"0",1);
	}
	else if(!strcmp(argv[1],"trigger"))
	{
		if(argc != 3) 
		{
			USAGE();
			exit(-1);
		}
		if(write(fd1,argv[2],strlen(argv[2])))
		{
			perror("write error");
		}
		else {
			USAGE();
		}
	}

	exit(0);
}
```


编写好程序后使用交叉编译器编译

```
source /opt/fsl-imx-x11/4.1.15-2.1.0/environment-setup-cortexa7hf-neon-poky-linux-gnueabi
${CC} led.c -o testled

book@100ask:~/kenspace/linux/linuxC$ ./testled on
/lib/ld-linux-armhf.so.3: No such file or directory
```

### 开发板上测试

使用 U 盘拷贝到开发板上，使用 df -h 查看设备挂载，找到可执行文件 testled 并执行。


## GPIO 应用编程

与 LED 设备一样，GPIO 同样也是通过 sysfs 方式进行操控，进入到 `/sys/class/gpio` 目录下

```
root@ATK-IMX6U:/sys/class/gpio# ls
export  gpiochip0  gpiochip128  gpiochip32  gpiochip64  gpiochip96  unexport
```










