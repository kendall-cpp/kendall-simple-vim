
- [BuildRoot_A1 代码提交](#buildroot_a1-代码提交)
  - [提交kernel gerrit](#提交kernel-gerrit)
  - [提交uboot gerrit](#提交uboot-gerrit)
- [andl 烧录命令记录](#andl-烧录命令记录)
- [Google项目](#google项目)
  - [整体编译](#整体编译)
  - [单独编译u-boot和kernel](#单独编译u-boot和kernel)
    - [uboot](#uboot)
    - [kernel](#kernel)
    - [整理成脚本编译](#整理成脚本编译)
- [Google项目板子和芯片相关型号](#google项目板子和芯片相关型号)
  - [ramdisk.img 解包](#ramdiskimg-解包)
  - [gpio xz 相关命令](#gpio-xz-相关命令)

-----

## BuildRoot_A1 代码提交

### 提交kernel gerrit


> - https://scgit.amlogic.com/#/admin/projects/kernel/common
> - Project
> - General
> - Project kernel/common
> - git clone ssh://shengken.lin@scgit.amlogic.com:29418/kernel/common

```sh
git config --global user.email "shengken.lin@amlogic.com"

git config --global user.name "shengken.lin"


# 第二个会提示：fatal: remote review already exists.
# git remote add origin url  类似
git remote add review ssh://shengken.lin@scgit.amlogic.com:29418/kernel/common.git
git remote add review ssh://shengken.lin@scgit.amlogic.com:29418/linux/buildroot.git
git remote add review ssh://shengken.lin@scgit.amlogic.com:29418/uboot.git



git branch -a | grep amlogic-4.19-dev  # git branch -a 查看远程分支
git checkout -t remotes/amlogic/amlogic-4.19-dev  # 切换分支
git branch  # 查看分支
git status
git add   # add 修改的文件
git commit --amend -s   # -s 代表添加当前用户
git push review HEAD:refs/for/amlogic-4.19-dev  # kernel的提交分支
```

- 提交查看：https://scgit.amlogic.com/#/dashboard/self

### 提交uboot gerrit


- 初次

git commit --amend

```
[Don't merge] Add a5_amlogictest bsp

PD#SWPL-89613

Problem:
U-boot environment preparationn

Solution:
Add a5_amlogictest bsp and finish compiling

Verify:
a5_av400
```

```sh
git config --local user.name "shengken.lin"
git config --local user.email "shengken.lin@amlogic.com"

git branch -a | grep amlogic-4.19-dev
git checkout -t remotes/amlogic/amlogic-4.19-dev  切换分支
git branch
# git add kendall
git status
git commit --amend -s    -s 代表添加当前用户,写注释
git push review HEAD:refs/for/amlogic-dev-2019
```

- 打 patch


```sh
git add arch/arm/dts/meson-a5-all32-amlogictest.dtsi
git add arch/arm/dts/meson-a5-av400.dtsi
git add board/amlogic/a5_amlogictest/a5_amlogictest.c
git add board/amlogic/a5_av400/a5_av400.c
git add cmd/amlogic/cmd_rpmb.c
git add common/Kconfig
git add drivers/mtd/nand/raw/aml_nand/nand_flash.c

git commit --amend -s --no-verify   忽略掉代码不规范错误
```

- 编写测试

```
[Don't merge] Change a5_amlogictest bsp

PD#SWPL-89613

Problem:
The hardware of the development board is nand unable to burn

Solution:
Change a5_amlogictest to nand

Verify:
a5_av400
```

- 提交

git push review HEAD:refs/for/amlogic-dev-2019

最终提交：https://scgit.amlogic.com/245893

----

## andl 烧录命令记录

```sh
adnl.exe  Download u-boot.bin 0x10000  # 上电强制进入烧录模式  强制烧录会进入USB模式，需要重USB下载
adnl.exe run
adnl.exe bl2_boot -F  u-boot.bin
# 上面不会下载到 flash
adnl.exe oem "store init 1"
adnl.exe oem "store boot_erase bootloader"
adnl.exe oem "store erase boot 0 0"
adnl.exe oem "store erase system 0 0"
adnl.exe Partition -P bootloader  -F  u-boot.bin
adnl.exe Partition -P boot  -F boot-sign.img
adnl.exe Partition -P system  -F system.img
adnl.exe oem "reset"
```

## Google项目

> Baud rate 为 115200

### 整体编译

```sh
google_source/eureka/amlogic_sdk$ ./sdk/build_scripts/build_all.sh ../chrome korlan
```

### 单独编译u-boot和kernel

- 先将下载的 boot.img 拷贝到 unpack_boot_ramdisk_script 
- 编译 uboot
- 拷贝 ramdisk 到 `To_shengken_sign/korlan/`
- 编译 kernel
- 用 andl 工具烧录 `Z:\workspace\google_source\eureka\amlogic_sdk\To_shengken_sign\korlan\korlan-p2`

> reboot update -- 进入烧录模式

#### uboot

- 编译

```sh
$ cd /mnt/fileroot/shengken.lin/workspace/google_source/eureka/amlogic_sdk/To_shengken_sign
$ ./main.sh ../../amlogic_sdk/ u-boot korlan p2 ../../chrome

# 或者
$ ./main.sh  /mnt/fileroot/shengken.lin/workspace/google_source/eureka/amlogic_sdk/ u-boot korlan p2 /mnt/fileroot/shengken.lin/workspace/google_source/eureka/chrome
```

- 烧录

```sh
# z/workspace/google_source/eureka/amloc_sdk/To_shengken_sign/korlan/korlan-p2
adnl.exe  Download u-boot.bin 0x10000  # 上电强制进入烧录模式
adnl.exe run
adnl.exe bl2_boot -F  u-boot.bin

adnl.exe oem "store init 1"
# reboot update 进入烧录模式
adnl.exe oem "store boot_erase bootloader"
adnl.exe Partition -P bootloader  -F  u-boot.bin
adnl.exe oem "reset"
```

**注意：** 每次Google 更新都需要拷贝 boot.img

[下载地址：](https://console.cloud.google.com/storage/browser/cast-partner-amlogic-internal/internal/master/korlan-eng/262831?pageState=(%22StorageObjectListTable%22:(%22f%22:%22%255B%255D%22))&prefix=&forceOnObjectsSortingFiltering=false)

下载完之后

将 D:\KendallFile\GoogleHome\internal_master_korlan-eng_309703_korlan-ota-korlan-p2-309703\boot.img 拷贝到 Z:\workspace\google_source\eureka\amlogic_sdk\unpack_boot_ramdisk_script

然后再使用 bash unpack_boot.sh ./boot.img ./boot_out unpack_boot 进行打包，接着拷贝

cp ramdisk.img.xz /mnt/fileroot/shengken.lin/workspace/google_source/eureka/amlogic_sdk/To_shengken_sign/korlan/ramdisk.img

#### kernel 

```sh
$ cd /mnt/fileroot/shengken.lin/workspace/google_source/eureka/amlogic_sdk/To_shengken_sign
$ ./main.sh ../../amlogic_sdk/ kernel korlan p2 ../../chrome

或者
$ ./main.sh /mnt/fileroot/shengken.lin/workspace/google_source/eureka/amlogic_sdk/ kernel korlan p2 /mnt/fileroot/shengken.lin/workspace/google_source/eureka/chrome
```

Note: 生成的 u-boot.bin & boot-sign.img, 在 korlan/korlan-p2 下面


到 powerShell

```sh
#  Z:\workspace\google_source\eureka\amlogic_sdk\To_shengken_sign\korlan\korlan-p2>
adnl.exe oem "store erase boot 0 0"
adnl.exe Partition -P boot  -F ./boot-sign.img
adnl.exe oem "reset"  重启
```

#### 整理成脚本编译

- kendall-complie_uboot_kernel.sh u-boot 编译 u-boot
- kendall-unpack_boot_copyRamdisk.sh
- kendall-complie_uboot_kernel.sh kernel  编译 kernel

> 生成的文件在 /mnt/fileroot/shengken.lin/workspace/google_source/eureka/amlogic_sdk/To_shengken_sign/korlan/korlan-p2

- 烧录

reboot update 进入烧录模式

> 考妣 system.img 到 Z:\workspace\google_source\eureka\amlogic_sdk\To_shengken_sign\korlan\korlan-p2 这个目录下

```sh
adnl.exe  Download u-boot.bin 0x10000  # 上电强制进入烧录模式
adnl.exe run
adnl.exe bl2_boot -F  u-boot.bin

adnl.exe oem "store init 1"
# 一般从这开始
adnl.exe oem "store boot_erase bootloader"
adnl.exe oem "store erase boot 0 0"
adnl.exe oem "store erase system 0 0"
adnl.exe Partition -P bootloader  -F  u-boot.bin
adnl.exe Partition -P boot  -F boot-sign.img
adnl.exe Partition -P system  -F system.img
adnl.exe oem "reset"    #重启
```

## Google项目板子和芯片相关型号

只需关注

- u-boot

> - u-boot/arch/arm/dts/meson-a1-a113l-korlan.dts
> - u-boot/arch/arm/mach-meson/board-common.c
> - arch/arm/mach-meson/a


### ramdisk.img 解包

### gpio xz 相关命令

```sh
mv ramdisk.img ramdisk.img.xz
unxz ramdisk.img.xz 
file ramdisk.img   # 查看文件类型
cpio -i -F ramdisk.img

打包 cpio 和 xz
find x* | cpio -o > ramdisk.img.cpio
xz -k   解压

如果是点 gz 结尾
gunzip rootfs.cpio.gz 
```

- xz 命令

```
xz -d  env.xz   解压
unxz   env.xz   解压

-z, --compress      强制压缩
-d, --decompress    强制解压
-t, --test          测试压缩文件完整性
-l, --list          列出有关文件的信息
-k, --keep          保留（不删除）输入文件
-f, --force         强制覆盖输出文件和（取消）压缩链接
-c, --stdout        写入标准输出，不删除输入文件
-0 .. -9            压缩预设；0-2快速压缩，3-5良好
                    压缩，6-9极好的压缩；默认值为6
```

**将 ramdisk.img 解压出来修改 init，再重新打包压缩回 ramdisk.img**

```sh
# 解压
mv ramdisk.img ramdisk.img.xz
unxz ramdisk.img.xz
cpio -i -F ramdisk.img   #解压cpio

write /dev/kmsg "INIT: early-init entry"

# 打包
find . |cpio -ov -H newc | xz -9  --check=crc32  > ../ramdisk.img
```

> 最后 uboot中执行 dmesg 查看日志 -- 带时间戳